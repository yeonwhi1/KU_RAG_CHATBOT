name: Deploy Streamlit to EC2 (Conda)

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH Remote Commands
        uses: appleboy/ssh-action@v1.0.3
        env:
          ENV_CONTENTS: ${{ secrets.ENV_FILE }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          port: 22
          envs: ENV_CONTENTS
          script: |
            # ==========================================
            # [사용자 설정] 아래 변수들을 상황에 맞게 수정하세요
            # ==========================================
            REPO_URL="https://github.com/yeonwhi1/KU_RAG_CHATBOT.git"
            DIR_NAME="KU_RAG_CHATBOT"
            FILE_NAME="Project.py"
            PORT="8501"
            CONDA_ENV="whii"  # <--- [중요] 여기에 생성해둔 가상환경 이름을 넣으세요!
            # ==========================================

            # 1. Miniforge 활성화 (SSH에서는 .bashrc가 자동 로드되지 않을 수 있음)
            # 설치 경로가 ~/miniforge3 가 아니라면 경로를 수정해야 합니다.
            if [ -f "$HOME/miniforge3/etc/profile.d/conda.sh" ]; then
                source "$HOME/miniforge3/etc/profile.d/conda.sh"
            else
                echo "Miniforge path not found! Check your installation."
                exit 1
            fi

            # 2. 가상환경 진입
            conda activate $CONDA_ENV
            echo "Activated Conda Env: $CONDA_ENV"

            # 3. Git Clone 또는 Pull
            if [ -d "$DIR_NAME" ]; then
              cd $DIR_NAME
              git pull origin main
            else
              git clone $REPO_URL
              cd $DIR_NAME
            fi

            # 4. .env 파일 생성
            echo "$ENV_CONTENTS" > .env
            echo ".env file created successfully."

            # 5. 패키지 설치 (가상환경 내부에서 실행됨)
            if [ -f "requirements.txt" ]; then
              pip install -r requirements.txt
            fi

            # 6. 기존 프로세스 종료
            PID=$(lsof -t -i:$PORT)
            if [ -n "$PID" ]; then
              kill -9 $PID
            fi

            # 7. Streamlit 백그라운드 실행
            # (conda activate 상태에서 실행되므로 가상환경의 streamlit이 사용됨)
            nohup streamlit run $FILE_NAME --server.port $PORT --server.runOnSave true > nohup.out 2>&1 &
            
            echo "Deployment with Conda complete!"
